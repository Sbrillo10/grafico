<?php
/**
 * Template used for single posts and other post-types
 * that don't have a specific template.
 *
 * @package Avada
 * @subpackage Templates
 */

// Do not allow directly accessing this file.
if ( ! defined( 'ABSPATH' ) ) {
	exit( 'Direct script access denied.' );
}


$type = wp_get_post_terms( get_the_ID(), 'graph_type', null )[0];
$share = wp_get_post_terms( get_the_ID(), 'graph_share', null )[0];
?>

<?php get_header(); ?>

<section id="content" <?php Avada()->layout->add_style( 'content_style' ); ?>>
	<?php $post_pagination = get_post_meta( $post->ID, 'pyre_post_pagination', true ); ?>
	<?php while ( have_posts() ) : ?>
		<?php the_post(); ?>

		<?php
			$isLungo = wp_get_post_terms( get_the_ID(), 'graph_type', null )[0]->slug == 'lungo';
			$lungoTermineProssimo = false;
			if (!$isLungo) {
				$prev = get_posts( array(
					'numberposts' => 1,
					'post_type' => 'graph',
					'orderby'          => 'date',
					'order'            => 'DESC',
					'exclude'      => array(get_the_id()),
					'date_query' => array(
						'before' => get_the_date('Y/m/d', get_the_ID()) . ' '. get_the_time('H:i', get_the_ID())
					),
					'tax_query' => array(
						array (
							'taxonomy' => 'graph_type',
							'field' => 'term_id',
							'terms' => $type->term_id,
						),
						array(
							'taxonomy' => 'graph_share',
							'field'    => 'term_id',
							'terms'    => $share->term_id,
						)
					),
					) );

				if ($prev != NULL) {
					$prev = $prev[0]->ID;
				}

				$next =  get_posts( array(
					'numberposts' => 1,
					'post_type' => 'graph',
					'orderby'          => 'date',
					'exclude'      => array(get_the_id()),
					'order'            => 'ASC',
					'date_query' => array(
						'after' => get_the_date('Y/m/d', get_the_ID()) . ' '. get_the_time('H:i', get_the_ID())
					),
					'tax_query' => array(
						array (
							'taxonomy' => 'graph_type',
							'field' => 'term_id',
							'terms' =>  $type->term_id,
						),
						array(
							'taxonomy' => 'graph_share',
							'field'    => 'term_id',
							'terms'    => $share->term_id,
						)
					),
				) );

				if ($next == NULL) {
					$next =  get_posts( array(
						'numberposts' => 1,
						'post_type' => 'graph',
						'orderby'          => 'date',
						'order'            => 'DESC',
						'tax_query' => array(
							array (
								'taxonomy' => 'graph_type',
								'field' => 'slug',
								'terms' => 'lungo',
							),
							array(
								'taxonomy' => 'graph_share',
								'field'    => 'term_id',
								'terms'    => $share->term_id,
							)
						),
					) );
					$lungoTermineProssimo = true;
				}

				if ($next != NULL) {
					$next = $next[0]->ID;
				}
			} else {
				$next = NULL;
				$prev = NULL;
			}

			/*$terms = get_terms( array(
				'taxonomy' => 'graph_share',
				'hide_empty' => false,
				'orderby' => 'name',
				'order' => 'ASC',
				'fields' => 'id=>name',
			) );

			$prevDone = false;
			$nextDone = false;

			foreach($terms as $id => $term) {
				if (strcasecmp($term, $share->name) > 0) {
					$nextTermId = get_posts( array(
						'numberposts' => 1,
						'post_type' => 'graph',
						'orderby'          => 'date',
						'order'            => 'DESC',
						'tax_query' => array(
							array (
								'taxonomy' => 'graph_type',
								'field' => 'term_id',
								'terms' =>  $type->term_id,
							),
							array(
								'taxonomy' => 'graph_share',
								'field'    => 'term_id',
								'terms'    => $id,
							)
						),
					) )[0]->ID;

					$nextTermName = $term;
					$nextDone = true;
				} elseif (strcasecmp($term, $share->name) < 0) {
					$prevTermId = get_posts( array(
						'numberposts' => 1,
						'post_type' => 'graph',
						'orderby'          => 'date',
						'order'            => 'DESC',
						'tax_query' => array(
							array (
								'taxonomy' => 'graph_type',
								'field' => 'term_id',
								'terms' =>  $type->term_id,
							),
							array(
								'taxonomy' => 'graph_share',
								'field'    => 'term_id',
								'terms'    => $id,
							)
						),
					) );
					if(count($prevTermId) != 0) {
						$prevTermId = $prevTermId[0]->ID;
					}
					
					$prevTermName = $term;
					$prevDone = true;
				}

				if($prevDone && $nextDone) {
					break;
				}
			}*/
		?>


		<article id="post-<?php the_ID(); ?>" <?php post_class( 'post' ); ?>>
			<?php $full_image = ''; ?>
		
			<div class="asd-container">
				<div class="asd-col asd-col1">
					<?php if ($prev){ ?>
						<a class="back" href="<?php echo get_permalink($prev); ?>">Precedente</a>
					<?php }elseif(!$prev && $isLungo){?>
						<a class="back" href="javascript:history.back()">Precedente</a>
					<?php } ?>
				</div>
				
				<div class="asd-col asd-col2">
					<?= wp_get_post_terms( get_the_ID(), 'graph_share', null )[0]->name ?>
				</div>
				<div class="asd-col asd-col3">
					<?php if ($next){ ?>
						<a class="next" href="<?php echo get_permalink($next); ?>"><?= $lungoTermineProssimo ? 'LungoTermine' : 'Successivo' ?></a>
					<?php } ?>
				</div>
			</div>

			<?php //the_content(); ?>

			<img style="border: 10px solid #112938;" class="zoooom" src="<?= get_the_post_thumbnail_url( get_the_ID() ) ?>" alt="Grafico e analisi tecnica <?= $share->name ?> con strategia di trading per il <?php the_date() ?>">

			<br><br>

			<?php
			/*
			<div class="asd-container">
				<div class="asd-col asd-col1">
					<a class="back" href="<?php echo get_permalink($prevTermId); ?>"><?php echo $prevTermName ?></a>
				</div>
				<div class="asd-col asd-col2">
					
				</div>
				<div class="asd-col asd-col3">
					<a class="next" href="<?php echo get_permalink($nextTermId); ?>"><?php echo $nextTermName ?></a>
				</div>
			</div>
			*/
			?>


			<?php if ( '' === Avada()->settings->get( 'blog_post_meta_position' ) || 'below_article' === Avada()->settings->get( 'blog_post_meta_position' ) || 'disabled' === Avada()->settings->get( 'blog_post_title' ) ) : ?>
				<?php echo avada_render_post_metadata( 'single' ); // WPCS: XSS ok. ?>
			<?php endif; ?>
			<?php do_action( 'avada_before_additional_post_content' ); ?>
			<?php avada_render_social_sharing(); ?>

			<?php $post_comments = get_post_meta( $post->ID, 'pyre_post_comments', true ); ?>
			<?php if ( ( Avada()->settings->get( 'blog_comments' ) && 'no' !== $post_comments ) || ( ! Avada()->settings->get( 'blog_comments' ) && 'yes' === $post_comments ) ) : ?>
				<?php wp_reset_postdata(); ?>
				<?php comments_template(); ?>
			<?php endif; ?>
			<?php do_action( 'avada_after_additional_post_content' ); ?>

		</article>
	<?php endwhile; ?>
	<?php wp_reset_postdata(); ?>
</section>
<?php do_action( 'avada_after_content' ); ?>
<?php
get_footer();

/* Omit closing PHP tag to avoid "Headers already sent" issues. */
